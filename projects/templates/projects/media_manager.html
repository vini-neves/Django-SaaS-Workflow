{% extends "projects/base.html" %}
{% load static %}

{% block title %}Gerenciador de Mídia - {{ client.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/media_manager.css' %}">
{% endblock %}

{% block content %}
<div class="page-container">

    <input type="hidden" id="clientId" value="{{ client.id }}">

    <input type="hidden" id="folderId" value="{{ current_folder.id|default:'' }}">

    {% csrf_token %}
    <div class="header-wrapper">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'media_dashboard' %}">Clientes</a></li>
                <li class="breadcrumb-item"><a href="{% url 'media_root' client.id %}">{{ client.name }}</a></li>
                {% for crumb in breadcrumbs %}
                <li class="breadcrumb-item"><a href="{% url 'media_folder' client.id crumb.id %}">{{ crumb.name }}</a>
                </li>
                {% endfor %}
                {% if current_folder %}
                <li class="breadcrumb-item active">{{ current_folder.name }}</li>
                {% endif %}
            </ol>
        </nav>

        <div class="actions-toolbar" style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-secondary" onclick="openModal('modalNewFolder')">
                <i data-feather="folder-plus"></i> Nova Pasta
            </button>

            <label for="fileInputApi" class="btn btn-primary" style="cursor: pointer; margin-bottom: 0;">
                <i data-feather="upload-cloud"></i> Upload de Arquivos
            </label>
            <input type="file" id="fileInputApi" multiple style="display: none;" onchange="uploadInBatch(this)">
        </div>
    </div>

    <div class="media-content" style="margin-top: 20px;">

        {% if subfolders %}
        <div class="media-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h4 class="section-title" style="margin:0; border:none;">Pastas ({{ subfolders.count }})</h4>
            </div>

            <div class="media-grid">
                {% for folder in subfolders %}
                <div class="folder-card-wrapper" style="position: relative;">

                    <a href="{% url 'media_folder' client.id folder.id %}" class="folder-card">

                        <div class="folder-visual">
                            <i data-feather="star" class="star-icon"></i>

                            {% if 'image' in folder.name|lower %}
                            <i data-feather="image" class="folder-logo"></i>
                            {% elif 'video' in folder.name|lower %}
                            <i data-feather="play-circle" class="folder-logo"></i>
                            {% else %}
                            <i data-feather="package" class="folder-logo"></i>
                            {% endif %}
                        </div>

                        <div class="folder-info">
                            <span class="folder-name">{{ folder.name }}</span>
                            <span class="folder-meta">
                                {{ folder.files.count }} itens
                            </span>
                        </div>
                    </a>

                    <div class="dropdown" style="position: absolute; bottom: 20px; right: 20px;">
                        <a href="#" role="button" id="dropdownMenuLink{{ folder.id }}" data-bs-toggle="dropdown"
                            aria-expanded="false" style="color:#9CA3AF;">
                            <i data-feather="more-horizontal"></i>
                        </a>

                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink{{ folder.id }}">
                            <li>
                                <a class="dropdown-item text-danger" href="#"
                                    onclick="confirmDelete(event, 'Excluir Pasta?', 'Isso apagará {{ folder.files.count }} arquivos!', document.getElementById('form-del-{{ folder.id }}'))">
                                    Excluir Pasta
                                </a>
                            </li>
                        </ul>
                        <form id="form-del-{{ folder.id }}" action="{% url 'delete_folder' folder.id %}" method="GET"
                            style="display:none;"></form>
                    </div>

                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if files %}
        
        <form id="batchForm" action="{% url 'media_download_batch' %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="download_token" id="downloadToken">
            <h4 class="section-title" style="margin-top: 30px;">Arquivos</h4>
            
            <div class="media-grid files-grid">
                {% for file in files %}
                <div class="media-item file-item" id="card-{{ file.id }}" onclick="toggleSelection('{{ file.id }}', event)" style="position: relative;">
                    
                    <input type="checkbox" name="selected_files" value="{{ file.id }}" class="file-select-checkbox" id="check-{{ file.id }}">
                    
                    <div class="file-preview">
                        <img src="{{ file.file.url }}" alt="{{ file.filename }}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px;">
                    </div>
                    
                    <div class="file-info">
                        <span>{{ file.filename }}</span>
                        <small>{{ file.file_size|filesizeformat }}</small>
                    </div>
                    
                    <a href="{% url 'delete_file' file.id %}" class="delete-btn-file" style="color: red;"
                        onclick="confirmDelete(event, 'Excluir Arquivo?', 'Não poderá ser recuperado.', this)">
                        Excluir
                    </a>
                </div>
                {% endfor %}
            </div>

            <div id="selectionBar" class="selection-bar">
                <span class="selection-count" id="selectionCount">0 selecionados</span>
                
                <button type="submit" class="btn-download-batch">
                    <i data-feather="download"></i> Baixar ZIP
                </button>

                <button type="button" onclick="clearSelection()" style="background:none; border:none; color:#9ca3af; cursor:pointer; margin-left: 10px;">
                    <i data-feather="x"></i>
                </button>
            </div>
        
        </form> {% endif %}
        <div id="selectionBar" class="selection-bar">
                <span class="selection-count" id="selectionCount">0 selecionados</span>
                
                <button type="submit" class="btn-download-batch">
                    <i data-feather="download"></i> Baixar ZIP
                </button>

                <button type="button" onclick="clearSelection()" style="background:none; border:none; color:#9ca3af; cursor:pointer; margin-left: 10px;">
                    <i data-feather="x"></i>
                </button>
            </div>

        {% if not subfolders and not files %}
        <div class="empty-state">
            <p>Pasta vazia. Faça upload de arquivos ou crie pastas.</p>
        </div>
        {% endif %}
    </div>

</div>

<div id="modalNewFolder" class="modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
    <div class="modal-content" style="background:#fff; padding:20px; border-radius:8px; width:400px;">
        <h3>Nova Pasta</h3>
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="create_folder" value="1">

            <div class="form-group">
                <label>Nome da Pasta</label>
                {{ folder_form.name }}
            </div>

            <div style="margin-top: 15px; text-align: right;">
                <button type="button" class="btn btn-light" onclick="closeModal(this)">Cancelar</button>
                <button type="submit" class="btn btn-success">Criar</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/feather-icons"></script>

<script src="{% static 'js/media_manager.js' %}"></script>
{% endblock %}