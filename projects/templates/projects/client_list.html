{% extends 'projects/base.html' %}
{% load static %}

{% block title %}Meus Clientes{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/pages/clients.css' %}">
{% endblock %}

{% block content %}



<div class="page-header">
    <div class="page-title">
        <h1>Meus Clientes</h1>
        <p>Gerencie seus clientes e contratos</p>
    </div>
    <button class="btn-add-client" onclick="openCreateModal()">
        <i class="fa-solid fa-plus"></i> Novo Cliente
    </button>
</div>

<div class="modern-table-container">
    <table class="modern-table">
        <thead>
            <tr>
                <th>Cliente</th>
                <th>Representante</th>
                <th>Contrato</th>
                <th>Canais</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for client in clients %}
            <tr>
                <td data-label="Cliente">
                    <div class="client-info">
                        <div class="client-avatar">
                            {% with client.name|slice:":2" as initials %}{{ initials|upper }}{% endwith %}
                        </div>
                        <span class="client-name">{{ client.name }}</span>
                    </div>
                </td>
                <td data-label="Representante">{{ client.nome_representante|default:"-" }}</td>
                <td data-label="Contrato">
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width: 60%;"></div>
                    </div>
                    <span class="contract-dates">
                        {% if client.data_finalizacao_contrato %}
                            Até {{ client.data_finalizacao_contrato|date:"M Y"|lower }}
                        {% else %}
                            Sem prazo
                        {% endif %}
                    </span>
                </td>
                <td data-label="Canais">
                    <div class="social-list">
                        {% for acc in client.social_accounts.all %}
                            {% if acc.platform == 'instagram' %}<div class="social-icon bg-insta"><i class="fa-brands fa-instagram"></i></div>{% endif %}
                            {% if acc.platform == 'facebook' %}<div class="social-icon bg-fb"><i class="fa-brands fa-facebook-f"></i></div>{% endif %}
                            {% if acc.platform == 'linkedin' %}<div class="social-icon bg-in"><i class="fa-brands fa-linkedin-in"></i></div>{% endif %}
                            {% if acc.platform == 'tiktok' %}<div class="social-icon bg-tik"><i class="fa-brands fa-tiktok"></i></div>{% endif %}
                        {% endfor %}
                    </div>
                </td>
                <td data-label="Status">
                    {% if client.is_active %}
                        <span class="badge badge-active">Ativo</span>
                    {% else %}
                        <span class="badge badge-inactive">Inativo</span>
                    {% endif %}
                </td>
                <td data-label="Ações">
                    <div class="actions-wrapper">
                        <button class="action-btn" type="button" data-url="{% url 'get_client_data_api' client.id %}" onclick="editClient(this)">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteClient({{ client.id }})">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="empty-msg">Nenhum cliente encontrado.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="clientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"> 
        <div class="modal-content custom-modal-content">
            
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Cadastrar Novo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeClientModal()"></button>
            </div>

            <div class="modal-body">
                <form id="clientForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" id="clientId" name="client_id">

                    <div class="modal-grid">
                        
                        <div class="col-left">
                            <div class="form-group">
                                <label>Nome Fantasia</label>
                                {{ add_client_form.name }}
                            </div>
                            <div class="form-group">
                                <label>CNPJ</label>
                                {{ add_client_form.cnpj }}
                            </div>
                            <div class="form-group">
                                <label>Nome do Representante</label>
                                {{ add_client_form.nome_representante }}
                            </div>
                            <div style="display:none;">{{ add_client_form.email_representante }}</div>

                            <div class="form-group">
                                <label>Período do Contrato</label>
                                <div class="date-range">
                                    {{ add_client_form.data_inicio_contrato }}
                                    <span>—</span>
                                    {{ add_client_form.data_finalizacao_contrato }}
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Contrato</label>
                                <div class="upload-box" onclick="triggerUpload('id_contract_file')">
                                    <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                                    <div class="upload-text">Arraste ou <span>clique para enviar</span></div>
                                    <span class="upload-hint">PDF, DOC até 10MB</span>
                                </div>
                                {{ add_client_form.contract_file }} </div>

                            <div class="form-group">
                                <label>Manual da Marca</label>
                                <div class="upload-box" onclick="triggerUpload('id_brand_manual_file')">
                                    <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                                    <div class="upload-text">Arraste ou <span>clique para enviar</span></div>
                                    <span class="upload-hint">PDF, DOC até 10MB</span>
                                </div>
                                {{ add_client_form.brand_manual_file }}
                            </div>
                        </div>

                        <div class="col-right">
                            <div class="social-section-title">Conectar Redes Sociais</div>
                            
                            <div class="social-toggle-list">
                                <div class="toggle-item">
                                    <div class="toggle-info"><i class="fa-brands fa-instagram toggle-icon" style="color:#bc1888;"></i> Instagram</div>
                                    <label class="switch"><input type="checkbox" id="toggleInstagram"><span class="slider"></span></label>
                                </div>
                                <div class="toggle-item">
                                    <div class="toggle-info"><i class="fa-brands fa-linkedin toggle-icon" style="color:#0077b5;"></i> LinkedIn</div>
                                    <label class="switch"><input type="checkbox" id="toggleLinkedin"><span class="slider"></span></label>
                                </div>
                                <div class="toggle-item">
                                    <div class="toggle-info"><i class="fa-brands fa-tiktok toggle-icon" style="color:#000;"></i> TikTok</div>
                                    <label class="switch"><input type="checkbox" id="toggleTiktok"><span class="slider"></span></label>
                                </div>
                                <div class="toggle-item">
                                    <div class="toggle-info"><i class="fa-brands fa-facebook toggle-icon" style="color:#1877f2;"></i> Facebook</div>
                                    <label class="switch"><input type="checkbox" id="toggleFacebook"><span class="slider"></span></label>
                                </div>
                            </div>

                            <div class="main-active-toggle" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--c-border); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight:700; font-size:0.9rem;">Cliente Ativo</div>
                                    <div style="font-size:0.75rem; color:#999;">Visível no sistema</div>
                                </div>
                                <label class="switch">
                                    {{ add_client_form.is_active }}
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                    </div> 
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" data-bs-dismiss="modal" onclick="closeClientModal()">Cancelar</button>
                <button type="button" class="btn-save" onclick="saveClient()">Salvar Cliente</button>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/pages/clients.js' %}"></script>
    
    <script>
        document.querySelectorAll('#clientForm input[type="text"], #clientForm input[type="date"], #clientForm input[type="email"]').forEach(el => {
            el.classList.add('form-control');
        });
    </script>
{% endblock %}