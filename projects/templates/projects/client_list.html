{% extends 'projects/base.html' %}
{% load static %}

{% block title %}Meus Clientes{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/pages/clients.css' %}">
{% endblock %}

{% block content %}



<div class="page-header">
    <div class="page-title">
        <h1>Meus Clientes</h1>
        <p>Gerencie seus clientes e contratos</p>
    </div>
    <button class="btn-add-client" onclick="openCreateModal()">
        <i class="fa-solid fa-plus"></i> Novo Cliente
    </button>
</div>

<div class="modern-table-container">
    <table class="modern-table">
        <thead>
            <tr>
                <th>Cliente</th>
                <th>Representante</th>
                <th>Contrato</th>
                <th>Canais</th>
                <th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for client in clients %}
            <tr>
                <td data-label="Cliente">
                    <div class="client-info">
                        <div class="client-avatar">
                            {% with client.name|slice:":2" as initials %}{{ initials|upper }}{% endwith %}
                        </div>
                        <span class="client-name">{{ client.name }}</span>
                    </div>
                </td>
                <td data-label="Representante">{{ client.nome_representante|default:"-" }}</td>
                <td data-label="Contrato">
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width: 60%;"></div>
                    </div>
                    <span class="contract-dates">
                        {% if client.data_finalizacao_contrato %}
                            Até {{ client.data_finalizacao_contrato|date:"M Y"|lower }}
                        {% else %}
                            Sem prazo
                        {% endif %}
                    </span>
                </td>
                <td data-label="Canais">
                    <div class="social-list">
                        {% for acc in client.social_accounts.all %}
                            {% if acc.platform == 'instagram' %}<div class="social-icon bg-insta"><i class="fa-brands fa-instagram"></i></div>{% endif %}
                            {% if acc.platform == 'facebook' %}<div class="social-icon bg-fb"><i class="fa-brands fa-facebook-f"></i></div>{% endif %}
                            {% if acc.platform == 'linkedin' %}<div class="social-icon bg-in"><i class="fa-brands fa-linkedin-in"></i></div>{% endif %}
                            {% if acc.platform == 'tiktok' %}<div class="social-icon bg-tik"><i class="fa-brands fa-tiktok"></i></div>{% endif %}
                        {% endfor %}
                    </div>
                </td>
                <td data-label="Status">
                    {% if client.is_active %}
                        <span class="badge badge-active">Ativo</span>
                    {% else %}
                        <span class="badge badge-inactive">Inativo</span>
                    {% endif %}
                </td>
                <td data-label="Ações">
                    <div class="actions-wrapper">
                        <button class="action-btn" type="button" data-url="{% url 'get_client_data_api' client.id %}" onclick="editClient(this)">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteClient({{ client.id }})">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="empty-msg">Nenhum cliente encontrado.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="clientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
        <div class="modal-content custom-modal-content">
            
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Cadastrar Novo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeClientModal()"></button>
            </div>

            <div class="modal-body">
                <form id="clientForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" id="clientId" name="client_id">

                    <div class="modal-grid">
                        
                        <div class="col-left">
                            <div class="form-group">
                                <label>Nome Fantasia</label>
                                {{ add_client_form.name }}
                            </div>
                            <div class="form-group">
                                <label>CNPJ</label>
                                {{ add_client_form.cnpj }}
                            </div>
                            <div class="form-group">
                                <label>Nome do Representante</label>
                                {{ add_client_form.nome_representante }}
                            </div>
                            <div class="form-group">
                                <label>Celular do Representante</label>
                                {{ add_client_form.celular_representante }}
                            </div>
                            <div class="form-group">
                                <label>Email do Representante</label>
                                {{ add_client_form.email_representante }}
                            </div>
                            <div style="display:none;">{{ add_client_form.email_representante }}</div>

                            <div class="form-group">
                                <label>Período do Contrato</label>
                                <div class="date-range">
                                    {{ add_client_form.data_inicio_contrato }}
                                    <span>—</span>
                                    {{ add_client_form.data_finalizacao_contrato }}
                                </div>
                            </div>

                            <div class="upload-row">

                                <div class="form-group">
                                    <label>Contrato</label>
                                    <div class="upload-box" id="box_anexo_contrato" onclick="triggerUpload('id_anexo_contrato', 'contrato')">
                                        <i class="fa-solid fa-file-contract upload-icon"></i> 
                                        <div class="upload-text">Enviar</div>
                                    </div>
                                    {{ add_client_form.anexo_contrato }}
                                </div>
                            
                                <div class="form-group">
                                    <label>Manual</label>
                                    <div class="upload-box" id="box_manual_marca" onclick="triggerUpload('id_manual_marca', 'manual')">
                                        <i class="fa-solid fa-book upload-icon"></i>
                                        <div class="upload-text">Enviar</div>
                                    </div>
                                    {{ add_client_form.manual_marca }}
                                </div>
                            
                                <div class="form-group">
                                    <label>Logo</label>
                                    <div class="upload-box" id="box_logo" onclick="triggerUpload('id_logo', 'logo')">
                                        <i class="fa-solid fa-image upload-icon"></i>
                                        <div class="upload-text">Enviar</div>
                                    </div>
                                    {{ add_client_form.logo }}
                                </div>
                            
                            </div>
                        </div>

                        <div class="col-right">
                            <div class="social-section-title">Conectar Redes Sociais</div>
                            
                            <div class="modal-grid-triple">
    
                                <div class="col-social">
                                    <div class="social-section-title"><i class="fa-solid fa-share-nodes"></i> Redes Sociais</div>
                                    <div class="social-toggle-list">
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-brands fa-facebook" style="color:#1877f2;"></i> Facebook</div>
                                            <label class="switch"><input type="checkbox" id="toggleFacebook"><span class="slider"></span></label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-brands fa-instagram" style="color:#bc1888;"></i> Instagram</div>
                                            <label class="switch"><input type="checkbox" id="toggleInstagram"><span class="slider"></span></label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-brands fa-linkedin" style="color:#0077b5;"></i> LinkedIn</div>
                                            <label class="switch"><input type="checkbox" id="toggleLinkedin"><span class="slider"></span></label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-brands fa-tiktok" style="color:#000;"></i> TikTok</div>
                                            <label class="switch"><input type="checkbox" id="toggleTiktok"><span class="slider"></span></label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-brands fa-pinterest" style="color:#bd081c;"></i> Pinterest</div>
                                            <label class="switch"><input type="checkbox" id="togglePinterest"><span class="slider"></span></label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-brands fa-youtube" style="color:#ff0000;"></i> YouTube</div>
                                            <label class="switch"><input type="checkbox" id="toggleYoutube"><span class="slider"></span></label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-solid fa-at" style="color:#000;"></i> Threads</div>
                                            <label class="switch"><input type="checkbox" id="toggleThreads"><span class="slider"></span></label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-brands fa-x-twitter" style="color:#000;"></i> X</div>
                                            <label class="switch"><input type="checkbox" id="toggleX"><span class="slider"></span></label>
                                        </div>
                                    </div>
                                </div>
                            
                                <div class="col-ads">
                                    <div class="social-section-title"><i class="fa-solid fa-rectangle-ad"></i> Anúncios (Ads)</div>
                                    <div class="social-toggle-list">
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-brands fa-facebook" style="color:#1877f2;"></i> Meta Ads</div>
                                            <label class="switch"><input type="checkbox" id="toggleMetaAds"><span class="slider"></span></label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-brands fa-google" style="color:#4285F4;"></i> Google Ads</div>
                                            <label class="switch"><input type="checkbox" id="toggleGoogleAds"><span class="slider"></span></label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-brands fa-linkedin" style="color:#0077b5;"></i> LinkedIn Ads</div>
                                            <label class="switch"><input type="checkbox" id="toggleLinkedinAds"><span class="slider"></span></label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-brands fa-tiktok" style="color:#000;"></i> TikTok Ads</div>
                                            <label class="switch"><input type="checkbox" id="toggleTiktokAds"><span class="slider"></span></label>
                                        </div>
                                    </div>
                                </div>
                            
                                <div class="col-google">
                                    <div class="social-section-title"><i class="fa-solid fa-chart-line"></i> Google Business</div>
                                    <div class="social-toggle-list">
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-solid fa-store" style="color:#4285F4;"></i> Meu Negócio</div>
                                            <label class="switch"><input type="checkbox" id="toggleGMN"><span class="slider"></span></label>
                                        </div>
                                        <div class="toggle-item">
                                            <div class="toggle-info"><i class="fa-solid fa-magnifying-glass-chart" style="color:#F4B400;"></i> Analytics 4</div>
                                            <label class="switch"><input type="checkbox" id="toggleGA4"><span class="slider"></span></label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="main-active-toggle" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--c-border); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight:700; font-size:0.9rem;">Cliente Ativo</div>
                                    <div style="font-size:0.75rem; color:#999;">Visível no sistema</div>
                                </div>
                                <label class="switch">
                                    {{ add_client_form.is_active }}
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                    </div> 
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" data-bs-dismiss="modal" onclick="closeClientModal()">Cancelar</button>
                <button type="button" class="btn-save" onclick="saveClient()">Salvar Cliente</button>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            
            <div class="modal-header">
                <h5 class="modal-title">Arquivo Existente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body text-center">
                <div id="previewContent" class="mb-3">
                    </div>
                
                <p id="previewFileName" class="text-muted small" style="word-break: break-all;"></p>

                <div class="d-grid gap-2">
                    <a id="btnDownloadFile" href="#" target="_blank" class="btn btn-primary">
                        <i class="fa-solid fa-download"></i> Baixar Arquivo
                    </a>
                    
                    <button type="button" class="btn btn-outline-secondary" onclick="replaceFile()">
                        <i class="fa-solid fa-rotate"></i> Substituir Arquivo
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>  

{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/pages/clients.js' %}"></script>
    
    <script>
        document.querySelectorAll('#clientForm input[type="text"], #clientForm input[type="date"], #clientForm input[type="email"]').forEach(el => {
            el.classList.add('form-control');
        });
    </script>
{% endblock %}