{# projects/templates/projects/base.html #}
{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    {% if agency_logo %}
    <link rel="icon" href="{{ agency_logo.url }}" />
    {% endif %}

    <title>{% block title %}Plataforma{% endblock %}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="{% static 'css/base.css' %}" />

    <style>
      :root {
        --primary-color: {{ agency_primary_color|default:"#333366" }};
        --secondary-color: {{ agency_secondary_color|default:"#007bff" }};
        --text-on-primary: #ffffff;
        --text-on-secondary: #ffffff;
        --bg-light: #f8f9fa;
        --border-color: #dee2e6;
        --sidebar-width: 250px;
      }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>

    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <button id="mobile-menu-btn" class="mobile-menu-btn">
        <i class="fas fa-bars"></i>
    </button>

    {% if messages %}
    <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 350px;">
        {% for message in messages %}
        <div style="padding: 15px; margin-bottom: 10px; border-radius: 5px; color: white; 
                    background-color: {% if message.tags == 'error' %}#dc3545{% elif message.tags == 'warning' %}#ffc107{% else %}#28a745{% endif %};
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: sans-serif; opacity: 0.95;">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="app-container">
        
        <aside class="sidebar" id="sidebar">
            
            <button id="close-sidebar-btn" class="close-sidebar-btn">
                <i class="fas fa-times"></i>
            </button>

            <div class="logo-container">
                {% if agency_logo %}
                <img src="{{ agency_logo.url }}" alt="Logo da Agência" class="agency-logo" />
                {% else %}
                <h3 class="agency-name">{{ request.tenant.name }}</h3>
                {% endif %}
            </div>

            <nav class="main-nav">
                <a href="{% url 'dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                    <i class="fa-solid fa-house "></i>
                    <span>Dashboard</span>
                </a>

                <div class="nav-group {% if 'kanban' in request.resolver_match.url_name %} active open {% endif %}" id="kanban-group-toggle">
                    <div class="nav-link nav-link-header">
                        <div class="nav-link-content">
                            <i class="fa-solid fa-table-columns"></i>
                            <span>Kanban</span>
                        </div>
                        <i data-feather="chevron-right" class="toggle-icon"></i>
                    </div>

                    <div class="submenu">
                        <a href="{% url 'kanban_general' %}" class="nav-item-sub {% if request.resolver_match.url_name == 'kanban_general' %}active{% endif %}">
                            Kanban Geral
                        </a>
                        <a href="{% url 'kanban_operational' %}" class="nav-item-sub {% if request.resolver_match.url_name == 'kanban_operational' %}active{% endif %}">
                            Kanban Operacional
                        </a>
                    </div>
                </div>

                <a href="{% url 'calendar_view' %}" class="nav-link {% if request.resolver_match.url_name == 'calendar_view' %}active{% endif %}">
                    <i class="fa-solid fa-calendar "></i>
                    <span>Calendário</span>
                </a>
                
                <a href="{% url 'social_dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'social_dashboard' %}active{% endif %}">
                    <i class="fa-solid fa-share-nodes"></i>
                    <span>Postagens</span>
                </a>
                
                <a href="{% url 'client_list' %}" class="nav-link {% if request.resolver_match.url_name == 'client_list' %}active{% endif %}">
                    <i class="fa-solid fa-handshake "></i>
                    <span>Clientes</span>
                </a>
                
                <a href="{% url 'user_list' %}" class="nav-link {% if request.resolver_match.url_name == 'user_list' %}active{% endif %}">
                    <i class="fa-solid fa-users-gear"></i>
                    <span>Usuários</span>
                </a>

                <a href="#" class="nav-link" id="nav-metrics-btn">
                    <i class="fa-solid fa-chart-column "></i>
                    <span>Métricas</span>
                </a>
            </nav>

            <div class="user-profile">
                <span class="username">Olá, {{ user.first_name }}</span>
                <form action="{% url 'logout' %}" method="post" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="logout-link">
                        <i data-feather="log-out"></i>
                        <span>Sair</span>
                    </button>
                </form>
            </div>
        </aside>

        <main class="content">
            {% block content %} {% endblock %}
        </main>
    </div>

    <div id="metrics-client-modal" class="modal" style="display: none; z-index: 2000;">
        <div class="modal-content" style="max-width: 400px; text-align: center; margin: 15% auto; background: #fff; padding: 20px; border-radius: 10px;">
            <span class="close-button" onclick="document.getElementById('metrics-client-modal').style.display='none'" style="float: right; cursor: pointer; font-size: 20px;">&times;</span>
            <h2 style="color: var(--primary-color)">Visualizar Métricas</h2>
            <p style="color: #666; margin-bottom: 20px">Selecione o cliente para ver o dashboard.</p>

            <select id="metrics-client-select" class="form-control" style="margin-bottom: 20px; width: 100%; padding: 10px;">
                <option value="" disabled selected>Carregando clientes...</option>
            </select>

            <button id="btn-go-metrics" class="btn btn-primary" style="background-color: var(--primary-color); width: 100%;">
                Ver Dashboard
            </button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <script>
        // Inicializa Feather Icons
        feather.replace();

        document.addEventListener("DOMContentLoaded", function () {
            
            // ===============================================
            // [MOBILE] Lógica do Menu Lateral (Sidebar)
            // ===============================================
            const mobileBtn = document.getElementById('mobile-menu-btn');
            const closeBtn = document.getElementById('close-sidebar-btn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            function toggleMenu() {
                // Adiciona/Remove a classe 'active' definida no CSS
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            }

            if(mobileBtn) mobileBtn.addEventListener('click', toggleMenu);
            if(closeBtn) closeBtn.addEventListener('click', toggleMenu);
            if(overlay) overlay.addEventListener('click', toggleMenu);

            // ===============================================
            // Lógica do Kanban Dropdown (Existente)
            // ===============================================
            const toggleGroup = document.getElementById("kanban-group-toggle");
            if (toggleGroup) {
                const submenu = toggleGroup.querySelector(".submenu");
                toggleGroup.querySelector(".nav-link-header").addEventListener("click", () => {
                    const is_open = toggleGroup.classList.toggle("open");
                    submenu.style.maxHeight = is_open ? submenu.scrollHeight + "px" : "0";
                });

                if (toggleGroup.classList.contains("open")) {
                    submenu.style.maxHeight = submenu.scrollHeight + "px";
                }
            }

            // ===============================================
            // Lógica do Modal de Métricas (Existente)
            // ===============================================
            const metricsBtn = document.getElementById("nav-metrics-btn");
            const metricsModal = document.getElementById("metrics-client-modal");
            const clientSelect = document.getElementById("metrics-client-select");
            const goBtn = document.getElementById("btn-go-metrics");

            // URL segura gerada pelo Django
            const CLIENT_LIST_API = "{% url 'get_clients_list_api' %}";
            // Truque para pegar a URL base substituindo o ID dummy '0'
            const raw_metrics_url = "{% url 'client_metrics' 0 %}";
            const METRICS_URL_BASE = raw_metrics_url.replace("/0/metrics/", "/");

            if (metricsBtn) {
                metricsBtn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    
                    // Se estiver no mobile, fecha o menu ao abrir o modal
                    if(sidebar.classList.contains('active')) {
                        toggleMenu();
                    }

                    metricsModal.style.display = "block";

                    try {
                        const response = await fetch(CLIENT_LIST_API);
                        const data = await response.json();

                        clientSelect.innerHTML = '<option value="" disabled selected>Selecione um cliente...</option>';
                        data.clients.forEach((client) => {
                            const option = document.createElement("option");
                            option.value = client.id;
                            option.textContent = client.name;
                            clientSelect.appendChild(option);
                        });
                    } catch (error) {
                        console.error("Erro ao buscar clientes:", error);
                        clientSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                    }
                });
            }

            if (goBtn) {
                goBtn.addEventListener("click", () => {
                    const clientId = clientSelect.value;
                    if (clientId) {
                        window.location.href = `${METRICS_URL_BASE}${clientId}/metrics/`;
                    } else {
                        alert("Por favor, selecione um cliente.");
                    }
                });
            }

            // Fecha modal ao clicar fora
            window.addEventListener("click", (e) => {
                if (e.target === metricsModal) metricsModal.style.display = "none";
            });
        });
    </script>

    {% block extra_js %} {% endblock %}
</body>
</html>